class UtilitiesPuzzle{constructor(){this.houses=[{id:"h1",label:"Casa 1",x:50,y:80},{id:"h2",label:"Casa 2",x:50,y:180},{id:"h3",label:"Casa 3",x:50,y:280}],this.utilities=[{id:"u1",label:"\ud83d\udca7",name:"Agua",x:450,y:80},{id:"u2",label:"\u26a1",name:"Electricidad",x:450,y:180},{id:"u3",label:"\ud83d\udd25",name:"Gas",x:450,y:280}],this.connections=[],this.isDrawing=!1,this.currentPath=[],this.drawingFrom=null,this.lineRadius=20,this.initializeSVG(),this.renderBoard(),this.setupEventListeners()}initializeSVG(){const t=document.getElementById("canvas");t.setAttribute("width","500"),t.setAttribute("height","360"),t.setAttribute("viewBox","0 0 500 360")}renderBoard(){document.getElementById("canvas").innerHTML="",this.connections.forEach(((t,e)=>{this.drawConnection(t,e)})),this.houses.forEach((t=>{this.drawNode(t,"house")})),this.utilities.forEach((t=>{this.drawNode(t,"utility")})),this.updateConnectionCounter()}drawNode(t,e){const i=document.getElementById("canvas"),n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class",`${e}${this.selectedNode?.id===t.id?" selected":""}`),n.setAttribute("data-id",t.id);const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",t.x),s.setAttribute("cy",t.y),s.setAttribute("r",this.lineRadius);const o=document.createElementNS("http://www.w3.org/2000/svg","text");o.setAttribute("x",t.x),o.setAttribute("y",t.y),o.setAttribute("fill","white"),o.textContent="utility"===e?t.label:t.label.replace("Casa ",""),n.appendChild(s),n.appendChild(o),n.addEventListener("click",(i=>this.handleNodeClick(t,e,i))),i.appendChild(n)}drawConnection(t,e){const i=document.getElementById("canvas"),n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",this.pathArrayToString(t.path)),n.setAttribute("class","connection-line"),n.setAttribute("data-index",e),n.addEventListener("click",(t=>{t.stopPropagation(),this.removeConnection(e)})),i.appendChild(n)}pathArrayToString(t){if(0===t.length)return"";let e=`M ${t[0].x} ${t[0].y}`;for(let i=1;i<t.length;i++)e+=` L ${t[i].x} ${t[i].y}`;return e}getNode(t){return[...this.houses,...this.utilities].find((e=>e.id===t))}handleNodeClick(t,e,i){i.stopPropagation(),i.preventDefault(),this.isDrawing=!0,this.drawingFrom=t,this.currentPath=[{x:t.x,y:t.y}],this.renderBoard()}handleMouseMove(t){if(!this.isDrawing)return;const e=document.getElementById("canvas").getBoundingClientRect(),i=500/e.width,n=360/e.height,s=(t.clientX-e.left)*i,o=(t.clientY-e.top)*n;this.currentPath.push({x:s,y:o}),this.renderDrawingPath()}handleTouchMove(t){if(!this.isDrawing)return;t.preventDefault();const e=document.getElementById("canvas").getBoundingClientRect(),i=t.touches[0],n=500/e.width,s=360/e.height,o=(i.clientX-e.left)*n,r=(i.clientY-e.top)*s;this.currentPath.push({x:o,y:r}),this.renderDrawingPath()}handleMouseUp(t){if(!this.isDrawing)return;const e=document.getElementById("canvas").getBoundingClientRect(),i=500/e.width,n=360/e.height,s=(t.clientX-e.left)*i,o=(t.clientY-e.top)*n,r=this.getNodeAtPosition(s,o);r&&r.id!==this.drawingFrom.id&&this.tryCreateConnection(this.drawingFrom,r),this.isDrawing=!1,this.drawingFrom=null,this.currentPath=[],this.renderBoard()}handleTouchEnd(t){if(!this.isDrawing)return;t.preventDefault();const e=document.getElementById("canvas").getBoundingClientRect(),i=t.changedTouches[0],n=500/e.width,s=360/e.height,o=(i.clientX-e.left)*n,r=(i.clientY-e.top)*s,a=this.getNodeAtPosition(o,r);a&&a.id!==this.drawingFrom.id&&this.tryCreateConnection(this.drawingFrom,a),this.isDrawing=!1,this.drawingFrom=null,this.currentPath=[],this.renderBoard()}getNodeAtPosition(t,e){const i=[...this.houses,...this.utilities];for(const n of i){if(Math.sqrt((t-n.x)**2+(e-n.y)**2)<=1.5*this.lineRadius)return n}return null}tryCreateConnection(t,e){const i=this.houses.find((e=>e.id===t.id)),n=this.utilities.find((t=>t.id===e.id)),s=this.utilities.find((e=>e.id===t.id)),o=this.houses.find((t=>t.id===e.id));if(i&&n||s&&o){const n=i?t.id:e.id,s=i?e.id:t.id;if(this.connections.some((t=>t.from===n&&t.to===s)))return;const o=this.simplifyPath(this.currentPath,5);this.wouldPathCross(o)?alert("\u274c \xa1Las l\xedneas se cruzan! No puedes hacer esta conexi\xf3n."):(this.connections.push({from:n,to:s,path:o}),this.checkWin())}}simplifyPath(t,e){if(t.length<=2)return t;const i=[t[0]];for(let n=e;n<t.length-1;n+=e)i.push(t[n]);return i.push(t[t.length-1]),i}renderDrawingPath(){const t=document.getElementById("canvas");let e=t.querySelector(".drawing-line");if(e&&e.remove(),this.currentPath.length>1){const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",this.pathArrayToString(this.currentPath)),e.setAttribute("class","drawing-line"),t.appendChild(e)}}wouldPathCross(t){for(const e of this.connections)if(this.pathsCross(t,e.path))return!0;return!1}pathsCross(t,e){for(let i=0;i<t.length-1;i++)for(let n=0;n<e.length-1;n++)if(this.linesCross(t[i].x,t[i].y,t[i+1].x,t[i+1].y,e[n].x,e[n].y,e[n+1].x,e[n+1].y))return!0;return!1}linesCross(t,e,i,n,s,o,r,a){const h=(t,e,i,n,s,o)=>(o-e)*(i-t)>(n-e)*(s-t);return h(t,e,s,o,r,a)!==h(i,n,s,o,r,a)&&h(t,e,i,n,s,o)!==h(t,e,i,n,r,a)}removeConnection(t){this.connections.splice(t,1),this.renderBoard()}updateConnectionCounter(){document.getElementById("connectionCounter").textContent=`Conexiones: ${this.connections.length}/9`}checkWin(){if(9===this.connections.length){const t=9;this.connections.length===t&&(this.renderBoard(),setTimeout((()=>{alert("\ud83c\udf89 \xa1Felicidades! \ud83c\udf89\n\n\xa1Has logrado lo imposible!\n\nConectaste las 3 casas con los 3 servicios sin que se crucen las l\xedneas.\n\nEsto desaf\xeda la topolog\xeda matem\xe1tica \ud83d\ude04")}),300))}}setupEventListeners(){document.getElementById("resetBtn").addEventListener("click",(()=>this.reset()));const t=document.getElementById("canvas");t.addEventListener("mousemove",(t=>this.handleMouseMove(t))),t.addEventListener("mouseup",(t=>this.handleMouseUp(t))),t.addEventListener("mouseleave",(t=>this.handleMouseUp(t))),t.addEventListener("touchmove",(t=>this.handleTouchMove(t)),{passive:!1}),t.addEventListener("touchend",(t=>this.handleTouchEnd(t)),{passive:!1})}reset(){this.connections=[],this.selectedNode=null,this.renderBoard()}}document.addEventListener("DOMContentLoaded",(()=>{window.puzzle=new UtilitiesPuzzle}));